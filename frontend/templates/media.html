{% extends "base.html" %}

{% block title %}Media - {{ app_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- Media Content -->
        <div class="lg:col-span-3">
            <div class="bg-[#1e293b] p-4 border border-[#334155]">
                <div id="media-container" class="text-center"></div>
            </div>
            
            <!-- Related Media -->
            <div class="mt-6">
                <h2 class="text-base font-bold mb-3 pb-2 border-b border-[#334155]">Related Media</h2>
                <div id="related-media" class="grid grid-cols-4 md:grid-cols-6 gap-2"></div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <!-- Information -->
            <div class="bg-[#1e293b] p-3 border border-[#334155] mb-4">
                <h3 class="text-sm font-bold mb-3 pb-2 border-b border-[#334155]">Information</h3>
                <div id="media-info-content" class="text-xs"></div>
            </div>
            
            <!-- Tags -->
            <div class="bg-[#1e293b] p-3 border border-[#334155] mb-4">
                <h3 class="text-sm font-bold mb-3 pb-2 border-b border-[#334155]">Tags</h3>
                <div id="tags-container"></div>
                
                <!-- Edit Tags (Admin Mode Only) -->
                <div id="edit-tags-section" style="display: none;" class="mt-3 pt-3 border-t border-[#334155]">
                    <form id="edit-tags-form">
                        <label class="block text-xs font-bold mb-2">Edit Tags</label>
                        <input type="text" id="tags-input" placeholder="tag1 tag2 tag3" class="w-full px-2 py-1 bg-[#0f172a] border border-[#334155] text-xs mb-2 focus:outline-none focus:border-blue-500">
                        <button type="submit" class="w-full px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs">Save Tags</button>
                    </form>
                </div>
            </div>

            <!-- AI Metadata (if present) -->
            <div id="ai-metadata-section" style="display: none;" class="bg-[#1e293b] p-3 border border-[#334155] mb-4">
                <h3 class="text-sm font-bold mb-3 pb-2 border-b border-[#334155]">AI Generation Data</h3>
                <div id="ai-metadata-content" class="text-xs"></div>
            </div>
            
            <!-- Actions -->
            <div class="bg-[#1e293b] p-3 border border-[#334155] mb-4">
                <h3 class="text-sm font-bold mb-3 pb-2 border-b border-[#334155]">Actions</h3>
                
                <div class="space-y-2">
                    <a id="download-btn" href="#" download class="block w-full px-3 py-1 bg-[#334155] hover:bg-[#475569] text-white text-center text-xs">Download</a>
                    
                    <!-- Admin Actions -->
                    <div id="admin-actions" style="display: none;" class="space-y-2 pt-2 border-t border-[#334155]">
                        <label class="block text-xs font-bold mb-1">Rating</label>
                        <select id="rating-select" class="w-full px-2 py-1 bg-[#0f172a] border border-[#334155] text-xs mb-2 focus:outline-none focus:border-blue-500">
                            <option value="safe">Safe</option>
                            <option value="questionable">Questionable</option>
                            <option value="explicit">Explicit</option>
                        </select>
                        
                        <button id="share-btn" class="w-full px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs">Share</button>
                        <button id="delete-btn" class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs">Delete</button>
                    </div>
                </div>
            </div>
            
            <!-- Share Link Display -->
            <div id="share-link-section" style="display: none;" class="bg-amber-600 p-3 border border-amber-700 mb-4">
                <h4 class="text-sm font-bold mb-2 text-black">Share Link</h4>
                <div class="mb-2 p-2 bg-black">
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-xs text-white font-medium">Include AI metadata</span>
                        <div class="relative">
                            <input type="checkbox" id="share-ai-metadata-toggle" class="sr-only peer">
                            <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                        </div>
                    </label>
                </div>
                <input type="text" id="share-link-input" readonly class="w-full px-2 py-1 bg-white border border-amber-700 text-xs mb-2 text-black">
                <div class="space-y-1">
                    <button id="copy-share-link-btn" class="w-full px-3 py-1 bg-black hover:bg-gray-900 text-white text-xs">Copy Link</button>
                    <button id="unshare-btn" class="w-full px-3 py-1 bg-gray-700 hover:bg-gray-800 text-white text-xs" style="display: none;">Remove Share</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const mediaId = "{{ media_id }}";
        let currentMedia = null;

        const el = id => document.getElementById(id);

        async function loadMedia() {
            try {
                const res = await fetch(`/api/media/${mediaId}`);
                currentMedia = await res.json();
                renderMedia(currentMedia);
                renderInfo(currentMedia);
                renderTags(currentMedia);
                await renderAIMetadata(currentMedia);
                if (app.isAdminMode) {
                    el('edit-tags-section').style.display = 'block';
                    el('admin-actions').style.display = 'block';
                    el('unshare-btn').style.display = 'block';
                }
                if (currentMedia.is_shared) {
                    showShareLink(currentMedia.share_uuid, currentMedia.share_ai_metadata);
                }
                await loadRelatedMedia();
            } catch (e) {
                console.error('loadMedia error', e);
            }
        }

        function renderMedia(media) {
            const c = el('media-container');
            c.innerHTML = media.file_type === 'video'
                ? `<video controls><source src="/api/media/${media.id}/file" type="${media.mime_type}"></video>`
                : `<img src="/api/media/${media.id}/file" alt="${media.filename}">`;
            el('download-btn').href = `/api/media/${media.id}/file`;
            el('download-btn').download = media.filename;
        }

        function renderInfo(m) {
            el('media-info-content').innerHTML = `
                <div class="info-row"><span>Filename</span><strong>${m.filename}</strong></div>
                <div class="info-row"><span>Type</span><strong>${m.file_type}</strong></div>
                <div class="info-row"><span>Size</span><strong>${formatFileSize(m.file_size)}</strong></div>
                <div class="info-row"><span>Dimensions</span><strong>${m.width}x${m.height}</strong></div>
                <div class="info-row"><span>Rating</span><strong>${m.rating}</strong></div>
                <div class="info-row"><span>Uploaded</span><strong>${new Date(m.uploaded_at).toLocaleDateString()}</strong></div>
                ${m.duration ? `<div class="info-row"><span>Duration</span><strong>${formatDuration(m.duration)}</strong></div>` : ''}
            `;
            const sel = el('rating-select');
            if (sel) sel.value = m.rating;
        }

        function renderTags(m) {
            const c = el('tags-container');
            const groups = { artist: [], character: [], copyright: [], general: [], meta: [] };
            (m.tags || []).forEach(t => groups[t.category]?.push(t));
            let html = '';
            Object.entries(groups).forEach(([cat, tags]) => {
                if (!tags.length) return;
                tags.sort((a, b) => a.name.localeCompare(b.name));
                html += `
                    <div class="tag-category">
                      <h4>${cat}</h4>
                      <div class="tag-list">
                        ${tags.map(t => `<a href="/?q=${encodeURIComponent(t.name)}" class="tag ${cat}">${t.name}</a>`).join('')}
                      </div>
                    </div>
                `;
            });
            c.innerHTML = html || '<p class="text-xs text-[#94a3b8]">No tags</p>';
            const input = el('tags-input');
            if (input) input.value = (m.tags || []).map(t => t.name).join(' ');
        }

        async function renderAIMetadata(m) {
            const section = el('ai-metadata-section');
            const content = el('ai-metadata-content');

            try {
                // Fetch metadata from the file
                const res = await fetch(`/api/media/${m.id}/metadata`);
                if (!res.ok) {
                    section.style.display = 'none';
                    return;
                }

                const metadata = await res.json();

                // Look for AI parameters in common fields
                let aiData = null;

                // Check for 'parameters' or 'Parameters' field
                if (metadata.parameters) {
                    aiData = typeof metadata.parameters === 'string' 
                        ? JSON.parse(metadata.parameters) 
                        : metadata.parameters;
                } else if (metadata.Parameters) {
                    aiData = typeof metadata.Parameters === 'string' 
                        ? JSON.parse(metadata.Parameters) 
                        : metadata.Parameters;
                } else if (metadata.prompt) {
                    aiData = typeof metadata.prompt === 'string' 
                        ? JSON.parse(metadata.prompt) 
                        : metadata.prompt;
                }

                // If no AI data found, hide section
                if (!aiData || Object.keys(aiData).length === 0) {
                    section.style.display = 'none';
                    return;
                }

                // Generate HTML
                let html = '';

                Object.entries(aiData).forEach(([key, value]) => {
                    const sectionTitle = formatKey(key);

                    html += `<div class="ai-section mb-3">`;
                    html += `<h4 class="text-xs font-bold text-blue-400 mb-2">${sectionTitle}</h4>`;
                    
                    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                        html += `<div class="ml-2">`;
                        Object.entries(value).forEach(([subKey, subValue]) => {
                            html += `
                                <div class="ai-data-row">
                                    <span class="text-[#94a3b8]">${formatKey(subKey)}:</span>
                                    <div class="text-[#f1f5f9]" style="text-align: right; flex: 1;">${formatValue(subValue, true)}</div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    } else {
                        html += `<div class="text-[#f1f5f9] ml-2">${formatValue(value, true)}</div>`;
                    }

                    html += `</div>`;
                });

                content.innerHTML = html;
                section.style.display = 'block';

            } catch (e) {
                console.error('Error rendering AI metadata:', e);
                section.style.display = 'none';
            }
        }

        function formatKey(key) {
            // Convert snake_case or camelCase to Title Case
            return key
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .trim()
                .replace(/\b\w/g, c => c.toUpperCase())
                .replace(/Cfgscale/g, 'CFG Scale')
                .replace(/Cfg Scale/g, 'CFG Scale')
                .replace(/Vae/g, 'VAE')
                .replace(/Aspectratio/g, 'Aspect Ratio')
                .replace(/Aspect Ratio/g, 'Aspect Ratio')
                .replace(/Automaticvae/g, 'Automatic VAE')
                .replace(/Automatic Vae/g, 'Automatic VAE')
                .replace(/Negativeprompt/g, 'Negative Prompt')
                .replace(/Negative Prompt/g, 'Negative Prompt');
        }

        function formatValue(value, isExpandable = true) {
            if (typeof value === 'boolean') {
                return value ? 'Yes' : 'No';
            }
            if (typeof value === 'string') {
                // Escape HTML and handle long strings
                const escaped = value.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                // If it's a long text, make it expandable
                if (isExpandable && escaped.length > 100) {
                    const id = 'expand-' + Math.random().toString(36).substr(2, 9);
                    return `
                        <div class="expandable-text" onclick="toggleExpand('${id}')" id="${id}-container">
                            <span class="text-truncated" id="${id}-truncated">${escaped.substring(0, 100)}... <span class="expand-indicator">[click to expand]</span></span>
                            <span class="text-full" id="${id}-full" style="display: none;">${escaped}</span>
                        </div>
                    `;
                }
                return escaped;
            }
            if (Array.isArray(value)) {
                return value.join(', ');
            }
            return String(value);
        }

        window.toggleExpand = function(id) {
            const truncated = document.getElementById(id + '-truncated');
            const full = document.getElementById(id + '-full');

            if (full.style.display === 'none') {
                truncated.style.display = 'none';
                full.style.display = 'inline';
            } else {
                truncated.style.display = 'inline';
                full.style.display = 'none';
            }
        }

        async function loadRelatedMedia() {
            if (!currentMedia || !currentMedia.tags || !currentMedia.tags.length) return;

            let generalTags = currentMedia.tags.filter(t => t.category === 'general');

            if (!generalTags.length) return;

            for (let i = generalTags.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [generalTags[i], generalTags[j]] = [generalTags[j], generalTags[i]];
            }

            const numTags = Math.min(3, Math.max(1, Math.floor(Math.random() * generalTags.length) + 1));
            const tagQuery = generalTags.slice(0, numTags).map(t => t.name).join(' ');

            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(tagQuery)}&limit=12`);
                const data = await res.json();
                const items = (data.items || []).filter(i => i.id !== mediaId);
                el('related-media').innerHTML = items.map(i =>`
                <a href="/media/${i.id}" class="gallery-item ${i.file_type}">
                    <img src="/api/media/${i.id}/thumbnail" alt="${i.filename}" loading="lazy">
                </a>
                `).join('');
            } catch (e) {
                console.error('related error', e);
            }
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 Bytes';
            const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }
        function formatDuration(s) {
            const m = Math.floor(s / 60), sec = Math.floor(s % 60);
            return `${m}:${String(sec).padStart(2, '0')}`;
        }

        el('edit-tags-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const tags = el('tags-input').value.split(/\s+/).filter(t => t.length > 0);
            try {
                await app.apiCall(`/api/media/${mediaId}`, { method: 'PATCH', body: JSON.stringify({ tags }) });
                location.reload();
            } catch (e) { alert('Error updating tags: ' + e.message); }
        });

        el('rating-select')?.addEventListener('change', async (e) => {
            try {
                await app.apiCall(`/api/media/${mediaId}`, { method: 'PATCH', body: JSON.stringify({ rating: e.target.value }) });
            } catch (e) { alert('Error updating rating: ' + e.message); }
        });

        el('share-btn')?.addEventListener('click', async () => {
            try {
                const res = await app.apiCall(`/api/media/${mediaId}/share`, { method: 'POST' });
                showShareLink(res.share_url.split('/').pop(), res.share_ai_metadata);
            } catch (e) { alert('Error creating share link: ' + e.message); }
        });
        el('copy-share-link-btn')?.addEventListener('click', () => {
            el('share-link-input').select(); document.execCommand('copy');
        });
        el('unshare-btn')?.addEventListener('click', async () => {
            try {
                await app.apiCall(`/api/media/${mediaId}/share`, { method: 'DELETE' });
                el('share-link-section').style.display = 'none';
            } catch (e) { alert('Error removing share: ' + e.message); }
        });

        el('delete-btn')?.addEventListener('click', async () => {
            if (!confirm('Delete this media?')) return;
            try {
                await app.apiCall(`/api/media/${mediaId}`, { method: 'DELETE' });
                window.location.href = '/';
            } catch (e) { alert('Error deleting media: ' + e.message); }
        });

        el('share-ai-metadata-toggle')?.addEventListener('change', async (e) => {
            try {
                await app.apiCall(`/api/media/${mediaId}/share-settings?share_ai_metadata=${e.target.checked}`, { 
                    method: 'PATCH'
                });
                console.log('Share settings updated:', e.target.checked);
            } catch (err) {
                console.error('Error updating share settings:', err);
                alert('Error updating share settings: ' + err.message);
                // Revert checkbox on error
                e.target.checked = !e.target.checked;
            }
        });

        function showShareLink(uuid, shareAIMetadata) {
            el('share-link-input').value = `${window.location.origin}/shared/${uuid}`;
            el('share-link-section').style.display = 'block';

            // Set checkbox state
            const aiMetadataToggle = el('share-ai-metadata-toggle');
            if (aiMetadataToggle) {
                aiMetadataToggle.checked = shareAIMetadata || false;
            }
        }

        // Initialize tag autocomplete
        const tagsInput = document.getElementById('tags-input');
        if (tagsInput) {
            new TagAutocomplete(tagsInput, {
                multipleValues: true
            });
        }

        loadMedia();
    });
</script>
{% endblock %}
