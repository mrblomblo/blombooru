<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared - {{ app_name }}</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link id="theme-stylesheet" rel="stylesheet" href="">
    <script>
        // Load theme on page load
        (async function loadTheme() {
            try {
                const response = await fetch('/api/admin/current-theme');
                const theme = await response.json();

                const themeLink = document.getElementById('theme-stylesheet');
                if (themeLink && theme.css_path) {
                    themeLink.href = theme.css_path;
                }
            } catch (error) {
                console.error('Error loading theme:', error);
                // Fallback to default dark theme
                const themeLink = document.getElementById('theme-stylesheet');
                if (themeLink) {
                    themeLink.href = '/static/css/themes/default_dark.css';
                }
            }
        })();
    </script>
</head>
<body class="bg text text-xs">
    <!-- Age Verification Overlay -->
    <div id="age-verification-overlay" class="age-verification-overlay" style="display: none;">
        <div class="surface border-2 border-[var(--danger)] p-8 max-w-md text-center">
            <svg class="mx-auto mb-4" width="64" height="64" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="#dc2626"/>
            </svg>
            <h2 class="text-xl font-bold mb-4 text-[var(--danger)]">Explicit Content Warning</h2>
            <p class="text-base mb-6 text">
                This media contains explicit content. By clicking "Yes, I am 18+", you confirm that you are over the age of 18 and consent to viewing adult content.
            </p>
            <div class="flex gap-4 justify-center">
                <button id="age-confirm-yes" class="px-6 py-3 bg-[var(--success)] hover:bg-[var(--success)] tag-text font-bold text-sm">
                    Yes, I am 18+
                </button>
                <button id="age-confirm-no" class="px-6 py-3 bg-[var(--danger)] hover:bg-[var(--danger-hover)] tag-text font-bold text-sm">
                    No, I am not 18
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4">
        <div class="bg-[var(--primary-color)] text-[var(--primary-text)] p-3 mb-4 flex items-center gap-2 text-xs">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
            </svg>
            <span class="font-bold">This content has been shared with you.</span>
        </div>
        
        <div id="shared-content"></div>
    </div>
    
    <script>
        const shareUuid = '{{ share_uuid }}';
        const el = id => document.getElementById(id);
        let currentMedia = null;
        
        async function loadSharedContent() {
            try {
                const response = await fetch(`/api/shared/${shareUuid}`);
                const data = await response.json();
                
                if (data.type === 'media') {
                    currentMedia = data.data;
                    renderSharedMedia(currentMedia);
                    
                    // Check if content is explicit and show age verification
                    if (currentMedia.rating === 'explicit') {
                        showAgeVerification();
                    }
                }
            } catch (error) {
                console.error('Error loading shared content:', error);
                document.getElementById('shared-content').innerHTML = `
                    <div class="text-center py-16">
                        <h2 class="text-lg font-bold mb-2">Content Not Found</h2>
                        <p class="text-xs text-secondary">This shared link is invalid or has been removed.</p>
                    </div>
                `;
            }
        }
        
        function showAgeVerification() {
            const overlay = el('age-verification-overlay');
            const mediaContainer = document.querySelector('.lg\\:col-span-3 > div');
            
            // Blur the media
            if (mediaContainer) {
                mediaContainer.classList.add('media-blurred');
            }
            
            // Show overlay
            overlay.style.display = 'flex';
            
            // Set up button handlers
            el('age-confirm-yes').addEventListener('click', () => {
                overlay.style.display = 'none';
                if (mediaContainer) {
                    mediaContainer.classList.remove('media-blurred');
                }
            });
            
            el('age-confirm-no').addEventListener('click', () => {
                // Try to close the tab/window, or navigate to about:blank
                window.close();
                // If window.close() doesn't work (some browsers block it), navigate away
                setTimeout(() => {
                    window.location.href = 'about:blank';
                }, 100);
            });
        }

        function renderSharedMedia(media) {
            const container = el('shared-content');

            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                    <div class="lg:col-span-3">
                        <div class="surface p-4 border text-center">
                            ${media.file_type === 'video' ? `
                                <video controls style="max-width: 100%; max-height: 80vh; margin: 0 auto;">
                                    <source src="/api/shared/${shareUuid}/file" type="${media.mime_type}">
                                </video>
                            ` : `
                                <img src="/api/shared/${shareUuid}/file" alt="${media.filename}" style="max-width: 100%; max-height: 80vh; margin: 0 auto;">
                            `}
                        </div>
                    </div>

                    <div class="lg:col-span-1">
                        <div class="surface p-3 border mb-4">
                            <h3 class="text-sm font-bold mb-3 pb-2 border-b">Information</h3>
                            <div id="media-info-content" class="text-xs"></div>
                        </div>

                        <div class="surface p-3 border mb-4">
                            <h3 class="text-sm font-bold mb-3 pb-2 border-b">Tags</h3>
                            <div id="tags-container"></div>
                        </div>

                        <div id="ai-metadata-section" style="display: none;" class="surface p-3 border mb-4">
                            <h3 class="text-sm font-bold mb-3 pb-2 border-b">AI Generation Data</h3>
                            <div id="ai-metadata-content" class="text-xs"></div>
                        </div>

                        <div class="surface p-3 border">
                            <h3 class="text-sm font-bold mb-3 pb-2 border-b">Actions</h3>
                            <div class="space-y-2">
                                <a id="download-btn" href="/api/shared/${shareUuid}/file" download="${media.filename}" class="block w-full px-3 py-2 surface-light surface-light-hover text text-center text-xs">
                                    Download
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Now render the data into the containers
            renderInfo(media);
            renderTags(media);
            renderAIMetadata(media);
        }
        
        function renderInfo(m) {
            el('media-info-content').innerHTML = `
                <div class="info-row"><span>Filename</span><strong>${m.filename}</strong></div>
                <div class="info-row"><span>Type</span><strong>${m.file_type}</strong></div>
                <div class="info-row"><span>Size</span><strong>${formatFileSize(m.file_size)}</strong></div>
                <div class="info-row"><span>Dimensions</span><strong>${m.width}x${m.height}</strong></div>
                <div class="info-row"><span>Rating</span><strong>${m.rating}</strong></div>
                <div class="info-row"><span>Uploaded</span><strong>${new Date(m.uploaded_at).toLocaleDateString()}</strong></div>
                ${m.duration ? `<div class="info-row"><span>Duration</span><strong>${formatDuration(m.duration)}</strong></div>` : ''}
            `;
        }
        
        function renderTags(m) {
            const c = el('tags-container');
            const groups = { artist: [], character: [], copyright: [], general: [], meta: [] };
            (m.tags || []).forEach(t => groups[t.category]?.push(t));
            let html = '';
            Object.entries(groups).forEach(([cat, tags]) => {
                if (!tags.length) return;
                tags.sort((a, b) => a.name.localeCompare(b.name));
                html += `
                    <div class="tag-category">
                      <h4>${cat}</h4>
                      <div class="tag-list">
                        ${tags.map(t => `<span class="tag ${cat} tag-text">${t.name}</span>`).join('')}
                      </div>
                    </div>
                `;
            });
            c.innerHTML = html || '<p class="text-xs text-secondary">No tags</p>';
        }

        async function renderAIMetadata(m) {
            const section = el('ai-metadata-section');
            const content = el('ai-metadata-content');
        
            // Check if AI metadata sharing is enabled
            if (!m.share_ai_metadata) {
                section.style.display = 'none';
                return;
            }
        
            try {
                // Fetch metadata from the shared endpoint
                const res = await fetch(`/api/shared/${shareUuid}/metadata`);
                if (!res.ok) {
                    section.style.display = 'none';
                    return;
                }
            
                const metadata = await res.json();
            
                // Look for AI parameters in common fields
                let aiData = null;
            
                if (metadata.parameters) {
                    aiData = typeof metadata.parameters === 'string' 
                        ? JSON.parse(metadata.parameters) 
                        : metadata.parameters;
                } else if (metadata.Parameters) {
                    aiData = typeof metadata.Parameters === 'string' 
                        ? JSON.parse(metadata.Parameters) 
                        : metadata.Parameters;
                } else if (metadata.prompt) {
                    aiData = typeof metadata.prompt === 'string' 
                        ? JSON.parse(metadata.prompt) 
                        : metadata.prompt;
                }
            
                if (!aiData || Object.keys(aiData).length === 0) {
                    section.style.display = 'none';
                    return;
                }
            
                let html = '';
            
                Object.entries(aiData).forEach(([key, value]) => {
                    const sectionTitle = formatKey(key);
                
                    html += `<div class="ai-section mb-3">`;
                    html += `<h4 class="text-xs font-bold text-[var(--primary-color)] mb-2">${sectionTitle}</h4>`;
                    
                    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                        html += `<div class="ml-2">`;
                        Object.entries(value).forEach(([subKey, subValue]) => {
                            html += `
                                <div class="ai-data-row">
                                    <span class="text-secondary">${formatKey(subKey)}:</span>
                                    <div class="text" style="text-align: right; flex: 1;">${formatValue(subValue, true)}</div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    } else {
                        html += `<div class="text ml-2">${formatValue(value, true)}</div>`;
                    }
                
                    html += `</div>`;
                });
            
                content.innerHTML = html;
                section.style.display = 'block';
            
            } catch (e) {
                console.error('Error rendering AI metadata:', e);
                section.style.display = 'none';
            }
        }

        function formatKey(key) {
            return key
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .trim()
                .replace(/\b\w/g, c => c.toUpperCase())
                .replace(/Cfgscale/g, 'CFG Scale')
                .replace(/Cfg Scale/g, 'CFG Scale')
                .replace(/Vae/g, 'VAE')
                .replace(/Aspectratio/g, 'Aspect Ratio')
                .replace(/Automaticvae/g, 'Automatic VAE')
                .replace(/Negativeprompt/g, 'Negative Prompt');
        }

        function formatValue(value, isExpandable = true) {
            if (typeof value === 'boolean') {
                return value ? 'Yes' : 'No';
            }
            if (typeof value === 'number') {
                return value.toLocaleString();
            }
            if (typeof value === 'string') {
                const escaped = value.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                if (isExpandable && escaped.length > 100) {
                    const id = 'expand-' + Math.random().toString(36).substr(2, 9);
                    return `
                        <div class="expandable-text" onclick="toggleExpand('${id}')" id="${id}-container">
                            <span class="text-truncated" id="${id}-truncated">${escaped.substring(0, 100)}... <span class="expand-indicator">[click to expand]</span></span>
                            <span class="text-full" id="${id}-full" style="display: none;">${escaped}</span>
                        </div>
                    `;
                }
                return escaped;
            }
            if (Array.isArray(value)) {
                return value.join(', ');
            }
            return String(value);
        }

        window.toggleExpand = function(id) {
            const truncated = document.getElementById(id + '-truncated');
            const full = document.getElementById(id + '-full');
        
            if (full.style.display === 'none') {
                truncated.style.display = 'none';
                full.style.display = 'inline';
            } else {
                truncated.style.display = 'inline';
                full.style.display = 'none';
            }
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return '0 Bytes';
            const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }
        
        function formatDuration(s) {
            const m = Math.floor(s / 60), sec = Math.floor(s % 60);
            return `${m}:${String(sec).padStart(2, '0')}`;
        }
        
        loadSharedContent();
    </script>
</body>
</html>
