{% extends "base.html" %}

{% block title %}Admin Panel - {{ app_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4 max-w-4xl">
    <h1 class="text-lg font-bold mb-4 pb-3 border-b">Admin Panel</h1>

    <div id="admin-panel">
        <!-- Settings Section -->
        <div id="settings-section" style="display: none;">
            <div class="surface p-2 sm:p-6 border mb-4">
                <h2 class="text-base font-bold mb-4 pb-3 border-b">Settings</h2>

                <form id="settings-form">
                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-2">Application Name</label>
                        <input type="text" id="app-name" name="app_name"
                            class="w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary">
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-2">Theme</label>
                        <div id="theme-select" class="custom-select" data-value="">
                            <button
                                class="custom-select-trigger w-full flex items-center justify-between gap-3 px-3 py-2 bg border text-xs cursor-pointer focus:outline-none hover:border-primary transition-colors focus:border-primary"
                                type="button">
                                <span class="custom-select-value text-secondary">Loading themes...</span>
                                <svg class="custom-select-arrow flex-shrink-0 transition-transform duration-200 text-secondary"
                                    width="12" height="12" viewBox="0 0 12 12">
                                    <path fill="currentColor" d="M6 9L1 4h10z" />
                                </svg>
                            </button>
                            <div
                                class="custom-select-dropdown bg border border-primary max-h-60 overflow-y-auto shadow-lg">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-2">Items Per Page</label>
                        <input type="number" id="items-per-page" name="items_per_page" min="20" max="200"
                            class="w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary">
                        <p class="text-xs text-secondary opacity-70 mt-1 ml-1">Number of items to display per page
                            (20-200)</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-2">External Share URL</label>
                        <input type="url" id="external-share-url" name="external_share_url"
                            placeholder="https://example.com"
                            class="w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary">
                        <p class="text-xs text-secondary opacity-70 mt-1 ml-1">
                            Base URL for share links (optional, e.g., https://example.com). Leave empty to use default.
                        </p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-2">Default Sort</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div id="default-sort" class="custom-select w-full" data-value="uploaded_at">
                                    <button
                                        class="custom-select-trigger w-full flex items-center justify-between gap-3 px-3 py-2 bg border text-xs cursor-pointer focus:outline-none hover:border-primary transition-colors focus:border-primary"
                                        type="button">
                                        <span class="custom-select-value">Upload Date</span>
                                        <svg class="custom-select-arrow flex-shrink-0 transition-transform duration-200 text-secondary"
                                            width="12" height="12" viewBox="0 0 12 12">
                                            <path fill="currentColor" d="M6 9L1 4h10z" />
                                        </svg>
                                    </button>
                                    <div
                                        class="custom-select-dropdown bg border border-primary max-h-60 overflow-y-auto shadow-lg">
                                        <div class="custom-select-option px-3 py-2 cursor-pointer hover:surface text-xs"
                                            data-value="uploaded_at">Upload Date</div>
                                        <div class="custom-select-option px-3 py-2 cursor-pointer hover:surface text-xs"
                                            data-value="filename">File Name</div>
                                        <div class="custom-select-option px-3 py-2 cursor-pointer hover:surface text-xs"
                                            data-value="file_size">File Size</div>
                                        <div class="custom-select-option px-3 py-2 cursor-pointer hover:surface text-xs"
                                            data-value="file_type">File Type</div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div id="default-order" class="custom-select w-full" data-value="desc">
                                    <button
                                        class="custom-select-trigger w-full flex items-center justify-between gap-3 px-3 py-2 bg border text-xs cursor-pointer focus:outline-none hover:border-primary transition-colors focus:border-primary"
                                        type="button">
                                        <span class="custom-select-value">Descending</span>
                                        <svg class="custom-select-arrow flex-shrink-0 transition-transform duration-200 text-secondary"
                                            width="12" height="12" viewBox="0 0 12 12">
                                            <path fill="currentColor" d="M6 9L1 4h10z" />
                                        </svg>
                                    </button>
                                    <div
                                        class="custom-select-dropdown bg border border-primary max-h-60 overflow-y-auto shadow-lg">
                                        <div class="custom-select-option px-3 py-2 cursor-pointer hover:surface text-xs"
                                            data-value="desc">Descending</div>
                                        <div class="custom-select-option px-3 py-2 cursor-pointer hover:surface text-xs"
                                            data-value="asc">Ascending</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-2">Security</label>
                        <div class="bg p-4 border">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="require-auth" name="require_auth"
                                    class="w-4 h-4 accent-primary">
                                <span class="text-xs">Require Authentication to View Media</span>
                            </label>
                            <p class="text-xs text-secondary opacity-70 mt-2 ml-6">
                                When enabled, users must log in to view media.
                                Public routes such as share links and static files remain public.
                            </p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-xs font-bold mb-2">Caching (Redis)</label>
                        <div class="bg p-4 border">
                            <label class="flex items-center gap-2 cursor-pointer mb-4">
                                <input type="checkbox" id="redis-enabled" name="redis_enabled"
                                    class="w-4 h-4 accent-primary">
                                <span class="text-xs font-bold">Enable Redis Caching</span>
                            </label>

                            <div id="redis-settings-container" style="display: none;">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label
                                            class="block text-[10px] font-bold uppercase tracking-wider mb-1 opacity-70">Host</label>
                                        <input type="text" id="redis-host"
                                            class="w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary"
                                            placeholder="localhost">
                                    </div>
                                    <div>
                                        <label
                                            class="block text-[10px] font-bold uppercase tracking-wider mb-1 opacity-70">Port</label>
                                        <input type="number" id="redis-port"
                                            class="w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary"
                                            placeholder="6379">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label
                                            class="block text-[10px] font-bold uppercase tracking-wider mb-1 opacity-70">
                                            DB Index
                                        </label>
                                        <input type="number" id="redis-db"
                                            class="w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary"
                                            placeholder="0">
                                    </div>
                                    <div>
                                        <label
                                            class="block text-[10px] font-bold uppercase tracking-wider mb-1 opacity-70">Password</label>
                                        <input type="password" id="redis-password"
                                            class="w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary"
                                            placeholder="Leave empty for none">
                                    </div>
                                </div>
                                <button type="button" id="test-redis-btn"
                                    class="px-4 py-2 bg-primary primary-text transition-colors hover:bg-primary text-xs">
                                    Test Redis Connection
                                </button>
                                <div id="redis-test-result" class="mt-2 text-xs" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <button type="submit"
                        class="px-4 py-2 bg-primary primary-text transition-colors hover:bg-primary text-xs">
                        Save Settings
                    </button>
                </form>
            </div>

            <!-- API Access Section -->
            <div class="surface p-2 sm:p-6 border mb-4">
                <h2 class="text-base font-bold mb-4 pb-3 border-b">API Access</h2>

                <p class="text-xs text-secondary mb-4">
                    API keys allow external applications to access the Booru API when authentication is required.
                </p>

                <div class="mb-6">
                    <button id="generate-api-key-btn"
                        class="px-4 py-2 bg-primary primary-text transition-colors hover:bg-primary text-xs">
                        Generate New API Key
                    </button>

                    <div id="new-api-key-display" style="display: none;"
                        class="mt-4 p-4 border border-primary bg bg-opacity-5">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold uppercase tracking-wider text-white">New API Key</span>
                            <span class="text-[10px] bg-danger tag-text px-1.5 py-0.5 font-bold">
                                SHOWN ONCE
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="new-api-key-value"
                                class="w-full surface px-3 py-2 border text-xs font-mono hover:border-primary transition-colors focus:outline-none focus:border-primary"
                                readonly>
                            <button id="copy-api-key-btn"
                                class="px-4 py-2 bg-primary primary-text border text-xs hover:bg-primary transition-colors whitespace-nowrap">
                                Copy Key
                            </button>
                        </div>
                        <p class="text-[10px] mt-2 opacity-70 italic font-bold">
                            Store this key securely. It will not be shown again after you refresh or leave this page.
                        </p>
                    </div>
                </div>

                <div id="api-keys-container">
                    <h3 class="text-sm font-bold mb-3">Active API Keys</h3>
                    <div id="api-keys-list" class="border">
                        <!-- Keys will be populated here as rows -->
                        <div class="bg p-4 text-center text-xs text-secondary">
                            Loading API keys...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Media Management Section -->
            <div class="surface p-2 sm:p-6 border mb-4">
                <h2 class="text-base font-bold mb-4 pb-3 border-b">Media Management</h2>
                <div id="media-stats" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                    <div class="bg p-3 border">
                        <div class="text-xs text-secondary">Total Media</div>
                        <div class="text-lg font-bold" id="total-media">0</div>
                    </div>
                    <div class="bg p-3 border">
                        <div class="text-xs text-secondary">Total Images</div>
                        <div class="text-lg font-bold" id="total-images">0</div>
                    </div>
                    <div class="bg p-3 border">
                        <div class="text-xs text-secondary">Total GIFs</div>
                        <div class="text-lg font-bold" id="total-gifs">0</div>
                    </div>
                    <div class="bg p-3 border">
                        <div class="text-xs text-secondary">Total Videos</div>
                        <div class="text-lg font-bold" id="total-videos">0</div>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-sm font-bold mb-3">Upload Media</h3>
                    <div class="bg p-4 border">
                        <p class="text-xs text-secondary mb-3">
                            You can upload images, videos, or compressed archives (ZIP, TAR.GZ).<br>
                            Supported image formats: JPG/JPEG, PNG, GIF, WEBP.<br>
                            Supported video formats: MP4, WEBM.<br>
                            Max individual file size: 500MB.<br>
                            Archives will be extracted and all supported media files inside will be processed.
                        </p>
                        <button id="scan-media-btn"
                            class="px-4 py-2 w-full bg-primary primary-text transition-colors hover:bg-primary text-xs mb-4">Scan
                            for Untracked Media</button>
                        <div id="upload-area" class="upload-area">
                            <p class="text-xs">Drop media files here or click to browse</p>
                            <input type="file" id="file-input" multiple accept="image/*,video/*,.zip,.tar.gz,.tgz">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tags Management Section -->
            <div class="surface p-2 sm:p-6 border mb-4">
                <h2 class="text-base font-bold mb-4 pb-3 border-b">Tags Management</h2>

                <div id="tag-stats" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                    <div class="bg p-3 border">
                        <div class="text-xs text-secondary">Total Tags</div>
                        <div class="text-lg font-bold" id="total-tags">0</div>
                    </div>
                    <div class="bg p-3 border">
                        <div class="text-xs text-secondary">Tag Aliases</div>
                        <div class="text-lg font-bold" id="total-aliases">0</div>
                    </div>
                    <div class="bg p-3 border">
                        <div class="text-xs text-secondary">Categories</div>
                        <div class="text-lg font-bold" id="total-categories">5</div>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-sm font-bold mb-3">Import Tags from CSV</h3>
                    <div class="bg p-4 border">
                        <p class="text-xs text-secondary mb-3">
                            Upload a CSV file with the following format:
                            (usage_count/column 3 will always be ignored)<br>
                            <code class="surface">
                                tag_name, category_number, usage_count, "alias1,alias2,alias3"
                            </code><br>
                            Categories: 0=General, 1=Artist, 3=Copyright, 4=Character, 5=Meta
                        </p>

                        <div id="csv-upload-area" class="upload-area">
                            <p class="text-xs">Drop CSV file here or click to browse</p>
                            <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                        </div>

                        <div id="csv-import-status" style="display: none;" class="mt-3">
                            <div class="text-xs">
                                <div id="csv-import-progress"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-sm font-bold mb-3">Add Tags</h3>
                    <div class="bg p-4 border">
                        <p class="text-xs text-secondary mb-3">
                            Add tags with optional category prefixes:<br>
                            <code class="surface">artist:&lt;tag&gt;</code>,
                            <code class="surface">copyright:&lt;tag&gt;</code>,
                            <code class="surface">character:&lt;tag&gt;</code>,
                            <code class="surface">meta:&lt;tag&gt;</code><br>
                            Tags without a prefix will be added as "general" category.<br>
                            Tags that already exist (or exist as aliases) will be ignored.
                        </p>

                        <form id="add-tags-form">
                            <label class="block text-xs font-bold mb-2">Tags to Add</label>
                            <div style="position: relative;">
                                <div id="new-tags-input" contenteditable="true"
                                    data-placeholder="artist:bingus character:herbert meta:ai-generated copyright:original cool_tag"
                                    class="w-full surface px-2 py-1 border text-xs mb-3 focus:outline-none hover:border-primary transition-colors focus:border-primary"
                                    style="min-height: 1.5rem; white-space: pre-wrap; overflow-wrap: break-word;"></div>
                            </div>
                            <button type="submit"
                                class="w-full px-4 py-2 bg-primary primary-text transition-colors hover:bg-primary text-xs">
                                Add Tags
                            </button>
                        </form>

                        <div id="add-tags-status" style="display: none;" class="mt-3">
                            <div class="text-xs">
                                <div id="add-tags-result"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-sm font-bold mb-3">Search & Delete Tags</h3>
                    <div class="flex gap-2 mb-3">
                        <div class="relative w-full">
                            <input type="text" id="tag-search-input" placeholder="Search tags..."
                                class="flex-1 w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary">
                        </div>
                        <button id="tag-search-btn"
                            class="px-4 py-2 bg-primary primary-text transition-colors hover:bg-primary text-xs">Search</button>
                    </div>
                    <div id="tag-search-results" class="max-h-64 overflow-y-auto"></div>
                </div>

                <div class="border-t pt-4">
                    <h3 class="text-sm font-bold mb-3 text-danger">Danger Zone</h3>
                    <button id="clear-tags-btn"
                        class="px-4 py-2 bg-danger transition-colors hover:bg-danger tag-text text-xs">
                        Delete All Tags
                    </button>
                </div>
            </div>

            <!-- Albums Management Section -->
            <div class="surface p-2 sm:p-6 border mb-4">
                <h2 class="text-base font-bold mb-4 pb-3 border-b">Albums Management</h2>

                <div id="album-stats" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                    <div class="bg p-3 border">
                        <div class="text-xs text-secondary">Total Albums</div>
                        <div class="text-lg font-bold" id="total-albums">0</div>
                    </div>
                    <div class="bg p-3 border">
                        <div class="text-xs text-secondary">Root Albums</div>
                        <div class="text-lg font-bold" id="root-albums">0</div>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-sm font-bold mb-3">Create Album</h3>
                    <div class="bg p-4 border">
                        <form id="create-album-form">
                            <div class="mb-3">
                                <label class="block text-xs font-bold mb-2">Album Name</label>
                                <input type="text" id="album-name-input" required
                                    class="w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary"
                                    placeholder="My Album">
                            </div>

                            <div class="mb-3" id="parent-album-container">
                                <label class="block text-xs font-bold mb-2">Parent Album (Optional)</label>
                                <div id="parent-album-select" class="custom-select" data-value="">
                                    <button
                                        class="custom-select-trigger w-full flex items-center justify-between gap-3 px-3 py-2 bg border text-xs cursor-pointer focus:outline-none hover:border-primary transition-colors focus:border-primary"
                                        type="button">
                                        <span class="custom-select-value text-secondary">None (Root Album)</span>
                                        <svg class="custom-select-arrow flex-shrink-0 transition-transform duration-200 text-secondary"
                                            width="12" height="12" viewBox="0 0 12 12">
                                            <path fill="currentColor" d="M6 9L1 4h10z" />
                                        </svg>
                                    </button>
                                    <div
                                        class="custom-select-dropdown bg border border-primary max-h-60 overflow-y-auto shadow-lg">
                                        <div class="custom-select-option px-3 py-2 cursor-pointer hover:surface text-xs selected"
                                            data-value="">None (Root Album)</div>
                                    </div>
                                </div>
                            </div>

                            <button type="submit"
                                class="w-full px-4 py-2 bg-primary primary-text transition-colors hover:bg-primary text-xs">
                                Create Album
                            </button>
                        </form>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-sm font-bold mb-3">Search & Manage Albums</h3>
                    <div class="flex gap-2 mb-3">
                        <div class="w-full">
                            <input type="text" id="album-search-input" placeholder="Search albums..."
                                class="flex-1 w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary">
                        </div>
                        <button id="album-search-btn"
                            class="px-4 py-2 bg-primary primary-text transition-colors hover:bg-primary text-xs">Search</button>
                    </div>
                    <div id="album-search-results" class="max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Backup & Restore Section -->
            <div class="surface p-2 sm:p-6 border mb-4">
                <h2 class="text-base font-bold mb-4 pb-3 border-b">Backup & Restore</h2>

                <div class="mb-4">
                    <h3 class="text-sm font-bold mb-3">Export Data</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <a href="/api/admin/backup/tags"
                            class="block w-full text-center px-4 py-2 surface-light hover:surface-light text-white transition-colors hover:bg-opacity-80 text-xs">
                            Export Tags (CSV)
                        </a>
                        <a href="/api/admin/backup/media"
                            class="block w-full text-center px-4 py-2 surface-light hover:surface-light text-white transition-colors hover:bg-opacity-80 text-xs">
                            Export Media (ZIP)
                        </a>
                        <a href="/api/admin/backup/full"
                            class="block w-full text-center px-4 py-2 bg-primary primary-text transition-colors hover:bg-primary text-xs">
                            Full Backup (ZIP)
                        </a>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-sm font-bold mb-3">Import Full Backup</h3>
                    <div class="bg p-4 border block">
                        <p class="text-xs text-secondary mb-3">
                            Restore a full backup ZIP. This will add missing tags and media files.<br>
                            Existing files with matching content (hashes) will be skipped.<br>
                            <strong>Warning:</strong> This process might take a while for large backups.
                        </p>

                        <div id="full-import-area" class="upload-area">
                            <p class="text-xs">Drop Full Backup ZIP here or click to browse</p>
                            <input type="file" id="full-import-input" accept=".zip" class="hidden">
                        </div>

                        <div id="full-import-status" style="display: none;" class="mt-3">
                            <div class="text-xs">
                                <div id="full-import-progress"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Account Management Section -->
            <div class="surface p-2 sm:p-6 border mb-4">
                <h2 class="text-base font-bold mb-4 pb-3 border-b">Admin Account Management</h2>

                <div class="mb-4">
                    <form id="change-admin-password-form">
                        <div class="mb-4">
                            <label class="block text-xs font-bold mb-2">New Password</label>
                            <input type="password" id="new-admin-password" required minlength="6" maxlength="50"
                                class="w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary">
                            <small class="text-secondary text-xs">6-50 characters</small>
                        </div>

                        <button type="submit"
                            class="px-4 py-2 bg-primary primary-text transition-colors hover:bg-primary text-xs">
                            Change Password
                        </button>
                    </form>

                    <div id="change-password-status" style="display: none;" class="mt-3">
                        <div class="text-xs">
                            <div id="change-password-result"></div>
                        </div>
                    </div>
                </div>

                <form id="change-admin-username-form" class="mt-6">
                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-2">New Username</label>
                        <input type="text" id="new-admin-username" required
                            class="w-full bg px-3 py-2 border text-xs focus:outline-none hover:border-primary transition-colors focus:border-primary">
                    </div>

                    <button type="submit"
                        class="px-4 py-2 bg-primary primary-text transition-colors hover:bg-primary text-xs">
                        Change Username
                    </button>
                </form>

                <div id="change-username-status" style="display: none;" class="mt-3">
                    <div class="text-xs">
                        <div id="change-username-result"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/fullscreen-mediaviewer.js?v={{ app_version }}"></script>
<script src="/static/js/tag-input-helper.js?v={{ app_version }}"></script>
<script src="/static/js/custom-select.js?v={{ app_version }}"></script>
<script src="/static/js/admin.js?v={{ app_version }}"></script>
<script src="/static/js/upload.js?v={{ app_version }}"></script>
{% endblock %}
