{% extends "base.html" %}

{% block title %}Album - {{ app_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4">
    <div class="mb-4">
        <div class="flex justify-between items-start mb-3">
            <div>
                <h1 id="album-name" class="text-lg font-bold"></h1>
                <p id="album-description" class="text-xs text-[#94a3b8] mt-1"></p>
            </div>
            
            <div id="admin-actions" style="display: none;" class="flex gap-2">
                <button id="edit-album-btn" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs">Edit</button>
                <button id="share-album-btn" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs">Share</button>
                <button id="delete-album-btn" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs">Delete</button>
            </div>
        </div>
        
        <div id="album-tags"></div>
        
        <!-- Share Link Display -->
        <div id="share-link-section" style="display: none;" class="bg-amber-600 p-3 border border-amber-700 mt-3">
            <h4 class="text-sm font-bold mb-2 text-black">Share Link</h4>
            <input type="text" id="share-link-input" readonly class="w-full px-2 py-1 bg-white border border-amber-700 text-xs mb-2 text-black">
            <div class="flex gap-2">
                <button id="copy-share-link-btn" class="flex-1 px-3 py-1 bg-black hover:bg-gray-900 text-white text-xs">Copy Link</button>
                <button id="unshare-btn" class="flex-1 px-3 py-1 bg-gray-700 hover:bg-gray-800 text-white text-xs">Remove Share</button>
            </div>
        </div>
    </div>
    
    <div id="album-media" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2"></div>
    
    <div id="loading-indicator" class="text-center py-8" style="display: none;">
        <div class="spinner"></div>
        <p class="text-[#94a3b8] mt-2">Loading...</p>
    </div>
</div>

<!-- Edit Album Modal -->
<div id="edit-album-modal" class="modal">
    <div class="bg-[#1e293b] p-6 border border-[#334155] max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h2 class="text-base font-bold mb-4">Edit Album</h2>
        
        <form id="edit-album-form">
            <div class="mb-4">
                <label class="block text-xs font-bold mb-2">Name</label>
                <input type="text" id="album-name-input" required class="w-full px-3 py-2 bg-[#0f172a] border border-[#334155] text-xs focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold mb-2">Description</label>
                <textarea id="album-description-input" class="w-full px-3 py-2 bg-[#0f172a] border border-[#334155] text-xs min-h-[80px] resize-y focus:outline-none focus:border-blue-500"></textarea>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold mb-2">Rating</label>
                <select id="album-rating-input" class="w-full px-3 py-2 bg-[#0f172a] border border-[#334155] text-xs focus:outline-none focus:border-blue-500">
                    <option value="safe">Safe</option>
                    <option value="questionable">Questionable</option>
                    <option value="explicit">Explicit</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold mb-2">Tags</label>
                <input type="text" id="album-tags-input" class="tag-input w-full px-3 py-2 bg-[#0f172a] border border-[#334155] text-xs focus:outline-none focus:border-blue-500" placeholder="tag1, tag2, tag3">
            </div>
            
            <div class="flex gap-2">
                <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs">Save Changes</button>
                <button type="button" id="cancel-edit-btn" class="flex-1 px-4 py-2 bg-[#334155] hover:bg-[#475569] text-white text-xs">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-top: 0.5rem;
    }
    
    .tag {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        font-size: 0.7rem;
        text-decoration: none;
        color: white;
        transition: opacity 0.2s;
    }
    
    .tag:hover {
        opacity: 0.8;
    }
    
    #album-media > div {
        position: relative;
        aspect-ratio: 1;
        overflow: hidden;
        border: 1px solid var(--border);
    }
    
    #album-media > div:hover {
        border-color: var(--primary-color);
    }
    
    #album-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .remove-from-album-btn {
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
        width: 1.5rem;
        height: 1.5rem;
        background-color: var(--danger);
        color: white;
        border: none;
        font-size: 1.2rem;
        line-height: 1;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: background-color 0.2s;
        z-index: 10;
    }
    
    .admin-mode .remove-from-album-btn {
        display: flex;
    }
    
    .remove-from-album-btn:hover {
        background-color: #dc2626;
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="/static/js/tag-autocomplete.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const albumId = "{{ album_id }}";
  let currentAlbum = null;
  let currentPage = 1;
  let hasMore = true;

  const el = id => document.getElementById(id);

  async function loadAlbum() {
    try {
      const res = await fetch(`/api/albums/${albumId}`);
      currentAlbum = await res.json();
      el('album-name').textContent = currentAlbum.name;
      el('album-description').textContent = currentAlbum.description || '';
      renderTags(currentAlbum.tags);
      if (app.isAdminMode) el('admin-actions').style.display = 'flex';
      if (currentAlbum.is_shared) showShareLink(currentAlbum.share_uuid);
      loadMedia();
    } catch (e) { console.error('loadAlbum error', e); }
  }

  async function loadMedia() {
    if (!hasMore) return;
    el('loading-indicator').style.display = 'block';
    try {
      const res = await fetch(`/api/albums/${albumId}/media?page=${currentPage}&limit=30`);
      const data = await res.json();
      renderMedia(data.items || []);
      currentPage++; hasMore = currentPage <= data.pages;
    } catch (e) { console.error('loadMedia error', e); }
    finally { el('loading-indicator').style.display = 'none'; }
  }

  function renderTags(tags) {
    if (!tags?.length) { el('album-tags').innerHTML = ''; return; }
    el('album-tags').innerHTML = `
      <div class="tag-list">
        ${tags.map(tag => `<a href="/?q=${encodeURIComponent(tag.name)}" class="tag ${tag.category}">${tag.name}</a>`).join('')}
      </div>`;
  }

  function renderMedia(items) {
    const c = el('album-media');
    items.forEach(item => {
      const div = document.createElement('div');
      div.dataset.mediaId = item.id;

      const a = document.createElement('a'); a.href = `/media/${item.id}`;
      const img = document.createElement('img'); img.src = `/api/media/${item.id}/thumbnail`; img.alt = item.filename; img.loading = 'lazy';
      a.appendChild(img); div.appendChild(a);

      if (app.isAdminMode) {
        const btn = document.createElement('button');
        btn.className = 'remove-from-album-btn'; btn.textContent = 'Ã—'; btn.title = 'Remove from album';
        btn.addEventListener('click', async (e) => {
          e.preventDefault(); e.stopPropagation();
          if (!confirm('Remove this item from the album?')) return;
          try {
            await app.apiCall(`/api/albums/${albumId}/media/${item.id}`, { method: 'DELETE' });
            div.remove();
          } catch (e) { alert('Error removing media from album: ' + e.message); }
        });
        div.appendChild(btn);
      }

      c.appendChild(div);
    });
  }

  function showEditModal() {
    const m = el('edit-album-modal');
    el('album-name-input').value = currentAlbum.name;
    el('album-description-input').value = currentAlbum.description || '';
    el('album-rating-input').value = currentAlbum.rating;
    el('album-tags-input').value = (currentAlbum.tags || []).map(t => t.name).join(', ');
    el('album-name-input').disabled = !!currentAlbum.is_system;
    m.classList.add('show');
  }
  function hideEditModal() { el('edit-album-modal').classList.remove('show'); }

  el('edit-album-btn')?.addEventListener('click', showEditModal);
  el('cancel-edit-btn')?.addEventListener('click', hideEditModal);

  el('edit-album-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const updates = {
      name: el('album-name-input').value,
      description: el('album-description-input').value,
      rating: el('album-rating-input').value,
      tags: el('album-tags-input').value.split(',').map(t => t.trim()).filter(Boolean)
    };
    try {
      await app.apiCall(`/api/albums/${albumId}`, { method: 'PATCH', body: JSON.stringify(updates) });
      hideEditModal(); location.reload();
    } catch (e) { alert('Error updating album: ' + e.message); }
  });

  el('share-album-btn')?.addEventListener('click', async () => {
    try {
      const r = await app.apiCall(`/api/albums/${albumId}/share`, { method: 'POST' });
      showShareLink(r.share_url.split('/').pop());
    } catch (e) { alert('Error creating share link: ' + e.message); }
  });
  el('copy-share-link-btn')?.addEventListener('click', () => { el('share-link-input').select(); document.execCommand('copy'); });
  el('unshare-btn')?.addEventListener('click', async () => {
    try { await app.apiCall(`/api/albums/${albumId}/share`, { method: 'DELETE' }); el('share-link-section').style.display = 'none'; }
    catch (e) { alert('Error removing share: ' + e.message); }
  });

  function showShareLink(uuid) {
    el('share-link-input').value = `${window.location.origin}/shared/${uuid}`;
    el('share-link-section').style.display = 'block';
  }

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(e => e.isIntersecting && hasMore && loadMedia());
  }, { rootMargin: '200px' });
  observer.observe(el('loading-indicator'));

  loadAlbum();
});
</script>
{% endblock %}
