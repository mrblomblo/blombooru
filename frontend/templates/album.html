{% extends "base.html" %}

{% block title %}Album - {{ app_name }}{% endblock %}

{% block content %}
<div class="container">
    <div style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h1 id="album-name"></h1>
                <p id="album-description" style="color: var(--text-secondary);"></p>
            </div>
            
            <div id="admin-actions" style="display: none;">
                <button id="edit-album-btn" class="btn btn-sm">Edit</button>
                <button id="share-album-btn" class="btn btn-sm">Share</button>
                <button id="delete-album-btn" class="btn btn-sm btn-danger">Delete</button>
            </div>
        </div>
        
        <div id="album-tags" style="margin-top: 1rem;"></div>
        
        <!-- Share Link Display -->
        <div id="share-link-section" style="display: none; margin-top: 1rem;">
            <h4>Share Link</h4>
            <input type="text" id="share-link-input" readonly style="width: 100%; max-width: 500px;">
            <button id="copy-share-link-btn" class="btn btn-sm">Copy Link</button>
            <button id="unshare-btn" class="btn btn-sm btn-secondary">Remove Share</button>
        </div>
    </div>
    
    <div id="album-media" class="gallery-grid"></div>
    
    <div id="loading-indicator" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>
</div>

<!-- Edit Album Modal -->
<div id="edit-album-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h2>Edit Album</h2>
        
        <form id="edit-album-form">
            <div class="form-group">
                <label for="album-name-input">Name</label>
                <input type="text" id="album-name-input" required>
            </div>
            
            <div class="form-group">
                <label for="album-description-input">Description</label>
                <textarea id="album-description-input"></textarea>
            </div>
            
            <div class="form-group">
                <label for="album-rating-input">Rating</label>
                <select id="album-rating-input">
                    <option value="safe">Safe</option>
                    <option value="questionable">Questionable</option>
                    <option value="explicit">Explicit</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="album-tags-input">Tags</label>
                <input type="text" id="album-tags-input" class="tag-input" placeholder="tag1, tag2, tag3">
            </div>
            
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button type="submit" class="btn">Save Changes</button>
                <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal.show {
        display: flex;
    }
    
    .modal-content {
        background: var(--surface);
        padding: 2rem;
        border-radius: 0.5rem;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    /* Remove from album button */
    .remove-from-album-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        width: 2rem;
        height: 2rem;
        background-color: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 1.5rem;
        line-height: 1;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: background-color 0.2s;
        z-index: 10;
    }
    
    .admin-mode .remove-from-album-btn {
        display: flex;
    }
    
    .remove-from-album-btn:hover {
        background-color: #dc2626;
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="/static/js/tag-autocomplete.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const albumId = "{{ album_id }}";
  let currentAlbum = null;
  let currentPage = 1;
  let hasMore = true;

  const el = id => document.getElementById(id);

  async function loadAlbum() {
    try {
      const res = await fetch(`/api/albums/${albumId}`);
      currentAlbum = await res.json();
      el('album-name').textContent = currentAlbum.name;
      el('album-description').textContent = currentAlbum.description || '';
      renderTags(currentAlbum.tags);
      if (app.isAdminMode) el('admin-actions').style.display = 'block';
      if (currentAlbum.is_shared) showShareLink(currentAlbum.share_uuid);
      loadMedia();
    } catch (e) { console.error('loadAlbum error', e); }
  }

  async function loadMedia() {
    if (!hasMore) return;
    el('loading-indicator').style.display = 'block';
    try {
      const res = await fetch(`/api/albums/${albumId}/media?page=${currentPage}&limit=30`);
      const data = await res.json();
      renderMedia(data.items || []);
      currentPage++; hasMore = currentPage <= data.pages;
    } catch (e) { console.error('loadMedia error', e); }
    finally { el('loading-indicator').style.display = 'none'; }
  }

  function renderTags(tags) {
    if (!tags?.length) { el('album-tags').innerHTML = ''; return; }
    el('album-tags').innerHTML = `
      <div class="tag-list">
        ${tags.map(tag => `<a href="/?q=${encodeURIComponent(tag.name)}" class="tag ${tag.category}">${tag.name}</a>`).join('')}
      </div>`;
  }

  function renderMedia(items) {
    const c = el('album-media');
    items.forEach(item => {
      const div = document.createElement('div');
      div.className = `gallery-item ${item.file_type}`;
      div.dataset.mediaId = item.id;
      div.style.position = 'relative';

      const a = document.createElement('a'); a.href = `/media/${item.id}`;
      const img = document.createElement('img'); img.src = `/api/media/${item.id}/thumbnail`; img.alt = item.filename; img.loading = 'lazy';
      a.appendChild(img); div.appendChild(a);

      if (app.isAdminMode) {
        const btn = document.createElement('button');
        btn.className = 'remove-from-album-btn'; btn.textContent = 'Ã—'; btn.title = 'Remove from album';
        btn.addEventListener('click', async (e) => {
          e.preventDefault(); e.stopPropagation();
          if (!confirm('Remove this item from the album?')) return;
          try {
            await app.apiCall(`/api/albums/${albumId}/media/${item.id}`, { method: 'DELETE' });
            div.remove();
          } catch (e) { alert('Error removing media from album: ' + e.message); }
        });
        div.appendChild(btn);
      }

      c.appendChild(div);
    });
  }

  function showEditModal() {
    const m = el('edit-album-modal');
    el('album-name-input').value = currentAlbum.name;
    el('album-description-input').value = currentAlbum.description || '';
    el('album-rating-input').value = currentAlbum.rating;
    el('album-tags-input').value = (currentAlbum.tags || []).map(t => t.name).join(', ');
    el('album-name-input').disabled = !!currentAlbum.is_system;
    m.classList.add('show');
  }
  function hideEditModal() { el('edit-album-modal').classList.remove('show'); }

  el('edit-album-btn')?.addEventListener('click', showEditModal);
  el('cancel-edit-btn')?.addEventListener('click', hideEditModal);

  el('edit-album-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const updates = {
      name: el('album-name-input').value,
      description: el('album-description-input').value,
      rating: el('album-rating-input').value,
      tags: el('album-tags-input').value.split(',').map(t => t.trim()).filter(Boolean)
    };
    try {
      await app.apiCall(`/api/albums/${albumId}`, { method: 'PATCH', body: JSON.stringify(updates) });
      hideEditModal(); alert('Album updated!'); location.reload();
    } catch (e) { alert('Error updating album: ' + e.message); }
  });

  el('share-album-btn')?.addEventListener('click', async () => {
    try {
      const r = await app.apiCall(`/api/albums/${albumId}/share`, { method: 'POST' });
      showShareLink(r.share_url.split('/').pop());
    } catch (e) { alert('Error creating share link: ' + e.message); }
  });
  el('copy-share-link-btn')?.addEventListener('click', () => { el('share-link-input').select(); document.execCommand('copy'); alert('Link copied!'); });
  el('unshare-btn')?.addEventListener('click', async () => {
    try { await app.apiCall(`/api/albums/${albumId}/share`, { method: 'DELETE' }); el('share-link-section').style.display = 'none'; alert('Share removed!'); }
    catch (e) { alert('Error removing share: ' + e.message); }
  });

  function showShareLink(uuid) {
    el('share-link-input').value = `${window.location.origin}/shared/${uuid}`;
    el('share-link-section').style.display = 'block';
  }

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(e => e.isIntersecting && hasMore && loadMedia());
  }, { rootMargin: '200px' });
  observer.observe(el('loading-indicator'));

  loadAlbum();
});
</script>
{% endblock %}
