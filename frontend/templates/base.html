<!DOCTYPE html>
<html lang="en">
{% from "components/icons.html" import dice_icon %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ app_name }}{% endblock %}</title>
    {% block pwa %}
    <link rel="manifest" href="/manifest.json?v={{ cache_buster }}">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js?v={{ cache_buster }}')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    {% endblock %}
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico?v={{ cache_buster }}">
    <link rel="stylesheet" href="/static/css/tailwind.css?v={{ cache_buster }}">
    <link rel="stylesheet" href="/static/css/main.css?v={{ cache_buster }}">
    <link id="theme-stylesheet" rel="stylesheet" href="{{ current_theme.css_path if current_theme else '' }}">
    <script>
        window.CURRENT_LANGUAGE = '{{ current_language() }}';
        window.SIDEBAR_FILTER_MODE = '{{ sidebar_filter_mode if sidebar_filter_mode is defined else "" }}';
    </script>
    {% if not current_theme %}
    <script>
        // Load theme on page load
        (async function loadTheme() {
            try {
                const response = await fetch('/api/admin/current-theme');
                const theme = await response.json();

                const themeLink = document.getElementById('theme-stylesheet');
                if (themeLink && theme.css_path) {
                    themeLink.href = theme.css_path + '?v={{ cache_buster }}';
                }
            } catch (error) {
                console.error('Error loading theme:', error);
                // Fallback to default dark theme
                const themeLink = document.getElementById('theme-stylesheet');
                if (themeLink) {
                    themeLink.href = '/static/css/themes/default_dark.css?v={{ cache_buster }}';
                }
            }
        })();
    </script>
    {% endif %}
    {% block extra_css %}{% endblock %}
    {% block head_extra %}{% endblock %}
</head>

<body class="bg text text-xs flex flex-col h-screen overflow-hidden"
    data-sidebar-mode="{{ sidebar_filter_mode if sidebar_filter_mode is defined else 'rating' }}">
    {% if show_header is not defined or show_header %}
    {% block header %}
    <header id="main-header"
        class="surface border-b z-50 shrink-0 fixed top-0 w-full transition-transform duration-300 ease-in-out">
        <div class="container mx-auto px-4 py-2">
            <div class="flex items-center justify-between gap-4">
                <a href="/" class="text-lg font-bold text-primary transition-colors hover:text-primary">
                    <span class="flex gap-2">
                        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="28" height="28"
                            viewBox="0 0 28 28">
                            <path
                                d="m23.078 3.281 0.279 0.232C26.027 5.807 27.726 9.3 28 12.797c0.226 3.764 -0.823 7.386 -3.281 10.281 -0.077 0.092 -0.153 0.184 -0.232 0.279C22.193 26.027 18.7 27.726 15.203 28c-3.764 0.226 -7.386 -0.823 -10.281 -3.281 -0.092 -0.077 -0.184 -0.153 -0.279 -0.232C1.973 22.193 0.274 18.7 0 15.203c-0.226 -3.764 0.823 -7.386 3.281 -10.281 0.077 -0.092 0.153 -0.184 0.232 -0.279C8.412 -1.059 17.427 -1.517 23.078 3.281"
                                fill="var(--primary-color)" />
                            <path
                                d="m11.67 6.257 0.342 0.001q0.357 0.002 0.715 0.01c0.361 0.007 0.722 0.009 1.084 0.01q0.348 0.003 0.697 0.007l0.323 0.002c1.822 0.043 3.614 0.828 4.892 2.13 1.311 1.434 1.903 3.099 1.935 5.036l0.017 0.368c0.021 0.672 -0.04 1.112 -0.345 1.71 -0.076 0.304 -0.076 0.304 -0.109 0.547h-0.219l-0.007 0.369C20.832 17.656 19.645 18.557 18.813 19.359l-0.294 0.31C18.266 19.906 18.266 19.906 17.958 19.94L17.719 19.906v0.219c-0.17 0.089 -0.341 0.175 -0.513 0.26l-0.288 0.146c-1.164 0.408 -2.395 0.39 -3.614 0.381l-0.501 -0.001a352.078 352.078 0 0 1 -1.305 -0.005c-0.446 -0.002 -0.892 -0.003 -1.337 -0.004Q8.853 20.898 7.547 20.891c-0.008 -0.804 -0.014 -1.607 -0.018 -2.411q-0.002 -0.409 -0.007 -0.819c-0.004 -0.394 -0.006 -0.788 -0.007 -1.182 -0.002 -0.121 -0.003 -0.241 -0.005 -0.365 0 -1.728 0.593 -3.106 1.799 -4.334 1.412 -1.319 3.139 -1.572 4.991 -1.513 1.021 0.059 1.946 0.454 2.634 1.221 0.164 0.213 0.316 0.424 0.457 0.653l0.124 0.185c0.149 0.397 0.135 0.788 0.135 1.209l0.008 0.256c0.005 0.94 -0.397 1.618 -1.033 2.287l-0.328 0.109 -0.005 -0.32c-0.037 -0.998 -0.104 -1.884 -0.863 -2.619 -0.912 -0.719 -1.838 -0.779 -2.96 -0.67 -0.828 0.173 -1.556 0.647 -2.078 1.313 -0.638 1.001 -0.632 1.993 -0.636 3.138a187.469 187.469 0 0 1 -0.008 0.521c-0.007 0.421 -0.01 0.842 -0.012 1.263q1.129 -0.011 2.258 -0.029 0.383 -0.005 0.767 -0.009c2.652 0.056 2.652 0.056 4.932 -1.117L17.938 17.391c0.328 -0.328 0.328 -0.328 0.488 -0.47 0.2 -0.221 0.282 -0.421 0.387 -0.699l0.103 -0.268c0.038 -0.103 0.077 -0.207 0.116 -0.313l0.085 -0.193c0.251 -0.594 0.294 -1.12 0.284 -1.762l-0.003 -0.293c-0.016 -0.68 -0.076 -1.285 -0.366 -1.908l-0.117 -0.253c-0.688 -1.347 -1.685 -2.054 -3.106 -2.521 -0.466 -0.119 -0.921 -0.115 -1.399 -0.111l-0.638 -0.006q-0.497 -0.002 -0.993 -0.001c-0.322 0 -0.645 -0.003 -0.967 -0.007l-0.298 0.003C10.867 8.581 10.483 8.472 9.953 8.094c-0.122 -0.231 -0.122 -0.231 -0.144 -0.472l-0.033 -0.238c0.246 -1.008 0.971 -1.152 1.894 -1.127"
                                fill="var(--primary-text)" />
                        </svg>
                        {{ app_name }}
                    </span>
                </a>

                <!-- Desktop Search -->
                <div class="flex-1 max-w-2xl hidden sm:block">
                    <form id="search-form" class="flex gap-2 items-center">
                        <div class="relative flex-1">
                            <input type="text" id="search-input" name="q"
                                placeholder="{{ t('nav.search_placeholder') }}"
                                value="{{ request.query_params.get('q', '') }}"
                                class="w-full bg px-3 py-1 border text text-xs focus:outline-none focus:border-primary hover:border-primary transition-colors">
                        </div>
                        <button type="button" id="search-random-btn"
                            class="p-1 border bg text hover:border-primary transition-colors"
                            title="{{ t('search.random') }}">
                            {{ dice_icon() }}
                        </button>
                        <button type="button" id="search-help-btn"
                            class="p-1 border bg text hover:border-primary transition-colors"
                            title="Search Syntax Guide">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </button>
                    </form>
                </div>

                <!-- Desktop Navigation -->
                <nav class="hidden sm:block">
                    <ul class="flex gap-2">
                        <li id="nav-albums-item">
                            <a href="/albums"
                                class="bg border px-3 py-1.5 hover:border-primary transition-colors {{ 'text-primary' if request.url.path.startswith('/albums') or request.url.path.startswith('/album/') else 'text' }}">
                                {{ t('nav.albums') }}
                            </a>
                        </li>
                        <li>
                            <a href="#" id="admin-mode-toggle"
                                class="bg border px-3 py-1.5 hover:border-primary transition-colors {{ 'text-primary' if request.url.path.startswith('/admin') else 'text' }}">
                                <span id="admin-mode-text">{{ t('nav.admin_panel') }}</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="logout-btn"
                                class="bg border px-3 py-1.5 hover:border-primary transition-colors ">
                                {{ t('nav.logout') }}
                            </a>
                        </li>
                    </ul>
                </nav>

                <div class="sm:hidden flex gap-2">
                    <button type="button" id="search-help-btn-mobile"
                        class="sm:hidden p-2 border bg hover:border-primary transition-colors"
                        title="Search Syntax Guide">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </button>

                    <!-- Mobile Nav Toggle -->
                    <button id="mobile-menu-btn"
                        class="group sm:hidden relative inline-flex items-center justify-center w-8 h-8 border bg hover:border-primary transition-colors focus:outline-none"
                        aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span
                            class="pointer-events-none absolute top-1/2 left-1/2 -translate-x-1/2 h-0.5 w-5 rounded-full bg-current transition-all
                            duration-200 ease-out -translate-y-2 group-[.is-active]:translate-y-0 group-[.is-active]:scale-x-0 group-[.is-active]:opacity-0"></span>

                        <span
                            class="pointer-events-none absolute top-1/2 left-1/2 -translate-x-1/2 h-0.5 w-5 rounded-full bg-current transition-all
                            duration-200 ease-out group-[.is-active]:-rotate-45 group-[.is-active]:scale-x-110 group-[.is-active]:bg-primary"></span>
                        <span
                            class="pointer-events-none absolute top-1/2 left-1/2 -translate-x-1/2 h-0.5 w-5 rounded-full transition-all
                            duration-200 ease-out group-[.is-active]:rotate-45 group-[.is-active]:scale-x-110 group-[.is-active]:bg-primary"></span>

                        <span
                            class="pointer-events-none absolute top-1/2 left-1/2 -translate-x-1/2 h-0.5 w-5 rounded-full bg-current transition-all
                            duration-200 ease-out translate-y-2 group-[.is-active]:translate-y-0 group-[.is-active]:scale-x-0 group-[.is-active]:opacity-0"></span>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation -->
            <nav id="mobile-menu" class="sm:hidden hidden border-y my-2">
                <ul class="flex flex-col py-2 gap-1">
                    <li id="nav-albums-item-mobile">
                        <a href="/albums"
                            class="block px-4 py-2 border bg hover:border-primary transition-colors {{ 'text-primary' if request.url.path.startswith('/albums') or request.url.path.startswith('/album/') else 'text' }}">
                            {{ t('nav.albums') }}
                        </a>
                    </li>
                    <li>
                        <a href="#" id="admin-mode-toggle-mobile"
                            class="block px-4 py-2 border bg hover:border-primary transition-colors {{ 'text-primary' if request.url.path.startswith('/admin') else 'text' }}">
                            <span id="admin-mode-text-mobile">{{ t('nav.admin_panel') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="logout-btn-mobile"
                            class="block px-4 py-2 border bg hover:border-primary transition-colors">
                            {{ t('nav.logout') }} </a>
                    </li>
                </ul>
            </nav>

            <!-- Mobile Search -->
            <div class="mt-2 sm:hidden">
                <form id="search-form-mobile" class="flex gap-2 items-center">
                    <div class="relative flex-1">
                        <input type="text" id="search-input-mobile" name="q"
                            placeholder="{{ t('nav.search_placeholder') }}"
                            value="{{ request.query_params.get('q', '') }}"
                            class="w-full bg px-3 py-2 border text text-xs focus:outline-none focus:border-primary hover:border-primary transition-colors">
                    </div>
                    <button type="button" id="search-random-btn-mobile"
                        class="p-2 border bg hover:border-primary transition-colors" title="{{ t('search.random') }}">
                        {{ dice_icon() }}
                    </button>
                </form>
            </div>
        </div>
    </header>
    {% endblock %}
    {% endif %}

    <main id="main-scroll" class="flex-1 h-full overflow-y-auto flex flex-col">
        <div class="flex-1 w-full">
            {% block content %}{% endblock %}
        </div>

        {% if show_footer is not defined or show_footer %}
        {% block footer %}
        <footer class="surface border-t mt-8">
            <div class="container mx-auto px-4 py-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="text-secondary text-xs">
                        <p>&copy; {{ app_name }} {{ get_current_year() }}. Powered by
                            <a href="https://github.com/mrblomblo/blombooru"
                                class="text-primary transition-colors hover:text-primary" target="_blank">Blombooru</a>
                            <span class="italic">v{{ app_version }}</span>.
                        </p>
                    </div>

                    <div class="flex gap-4 text-xs">
                        <a href="https://github.com/mrblomblo/blombooru"
                            class="text-secondary transition-colors hover:text-primary" target="_blank">GitHub</a>
                        <span class="text-tertiary">&#x2022;</span>
                        <a href="#" class="text-secondary transition-colors hover:text-primary"
                            onclick="document.getElementById('main-scroll').scrollTo({top: 0, behavior: 'smooth'}); return false;">
                            {{ t('footer.back_to_top') }}
                        </a>
                    </div>
                </div>
            </div>
        </footer>
        {% endblock %}
        {% endif %}
    </main>

    <script src="/static/js/modal-helper.js?v={{ cache_buster }}"></script>
    <script src="/static/js/main.js?v={{ cache_buster }}"></script>
    <script src="/static/js/tag-autocomplete.js?v={{ cache_buster }}"></script>

    {% if show_header is not defined or show_header %}
    <script>
        // Initialize tag autocomplete
        const searchInput = document.getElementById('search-input');
        const searchInputMobile = document.getElementById('search-input-mobile');
        if (searchInput) {
            new TagAutocomplete(searchInput, {
                multipleValues: true
            });
        }
        if (searchInputMobile) {
            new TagAutocomplete(searchInputMobile, {
                multipleValues: true
            });
        }
    </script>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const header = document.getElementById('main-header');
            const mainScroll = document.getElementById('main-scroll');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const adminToggle = document.getElementById('admin-mode-toggle');
            const adminToggleMobile = document.getElementById('admin-mode-toggle-mobile');
            const logoutBtn = document.getElementById('logout-btn');
            const logoutBtnMobile = document.getElementById('logout-btn-mobile');

            if (!header || !mainScroll) return;

            const adjustPadding = () => {
                const height = header.offsetHeight;
                mainScroll.style.paddingTop = `${height}px`;
            };

            adjustPadding();
            window.addEventListener('resize', adjustPadding);

            let lastScrollTop = 0;

            mainScroll.addEventListener('scroll', () => {
                const currentScroll = mainScroll.scrollTop;

                if (currentScroll <= 0) {
                    header.classList.remove('-translate-y-full');
                    return;
                }

                if (currentScroll > lastScrollTop && currentScroll > 60) {
                    header.classList.add('-translate-y-full');
                }
                else if (currentScroll < lastScrollTop) {
                    header.classList.remove('-translate-y-full');
                }

                lastScrollTop = currentScroll;
            });

            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', () => {
                    const isHidden = mobileMenu.classList.toggle('hidden');
                    mobileMenuBtn.classList.toggle('is-active');
                    mobileMenuBtn.setAttribute('aria-expanded', !isHidden);
                    setTimeout(adjustPadding, 10);
                });

                document.addEventListener('click', (e) => {
                    if (!header.contains(e.target) && !mobileMenu.classList.contains('hidden')) {
                        mobileMenu.classList.add('hidden');
                        mobileMenuBtn.classList.remove('is-active');
                        mobileMenuBtn.setAttribute('aria-expanded', 'false');
                        setTimeout(adjustPadding, 10);
                    }
                });

                if (adminToggleMobile && adminToggle) {
                    adminToggleMobile.addEventListener('click', (e) => {
                        e.preventDefault();
                        adminToggle.click();
                    });
                }

                if (logoutBtnMobile && logoutBtn) {
                    logoutBtnMobile.addEventListener('click', (e) => {
                        e.preventDefault();
                        logoutBtn.click();
                    });
                }
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>
